---
layout: post
title: Istio 利用 eBPF 实现另一种更高效的代理想法
categories: [general]
tags:
fullview: false
keywords: Istio, cilium, bpf
description:
---

#### 背景和想法

Service Mesh 提供了集群服务化开发的新思路，核心主要是构建一个代理转发网络结合控制和转发分离的思想来做集群应用调度管理，而 Linux Kernel 提供一种运行时高效扩可编程的网络注入机制 eBPF，并借此能实现 L47 层代理转发，假如借助 eBPF，并应用到 Service Mesh 的数据转发层，作为一个新组件，对接 Pilot、Mixer 控制面，实现控制层的策略和流量管理，是否是一种新方式？这种方式比使用 Envoy 具有更好的性能，虽然性能未必是 Mesh 首要考虑的问题，倒不妨是一种有趣的新尝试。（后发现 Cilium 已经尝试对接了 Istio 了，具体详情 [http://docs.cilium.io/en/latest/gettingstarted/istio/](http://docs.cilium.io/en/latest/gettingstarted/istio/)），在 Istio 看来 Envoy 作为 Pod 里的一个 SideCar 容器运行，而 Cilium 把 Envoy 运行在应用 Pod 之外，为每一个 Pod 运行一个单独的监听器，这两种模型各有利弊，没有孰好孰坏。
Istio 集成 Cilium 架构如下：

![img](/assets/media/istio_overview-7e6d28cafd5bf0e1e276b7ff7a72ab35-84ad3.png)

同时 Cilium 做了一个延迟测试，Pod - Proxy - Pod 下的代理性能如下：

![img](/assets/media/proxy_latency-cfa84e044543201194706ffead9a024c-84ad3.png))

#### Service Mesh

2016 年，两个不为人知的小项目 linked 和 Envoy 肯定没有想到两年后的今天，火遍了微服务圈，开启了一个全新的应用服务实现思路：无侵入式微服务架构，这种架构有星星燎原之势取代旧的服务架构 SpringCloud，我被这种优雅的架构所感动。而所有的架构都是为了更好的支撑灵活的应用，一个大型的应用系统复杂度是常人难以想象的，有时候甚至感到疲惫不堪和力不从心，而框架的职责是把复杂度下沉到框架层面，这样对于技术弱点的应用开发是巨大的福音，但代价就是你得像蜗牛一样背负着笨重的代价，轻应用重框架，没有银弹这句话铭记于心，而新的服务化框架似乎又慢慢在解决这种问题，至少在解耦集群服务的依赖，***但我们大胆想象下，对于应用的数据库访问是否也能被解耦和剥离呢？本质上 database proxy 也是代理的思想，只不过 mesh 是一种分布式代理，实际上目前已经有人开始探索 database mesh了。***

SpringCloud 是一种服务化应用框架，应用基于他们的模型快速进行集群服务化应用开发，官方解释如下：

`Spring Cloud provides tools for developers to quickly build some of the common patterns in distributed systems (e.g. configuration management, service discovery, circuit breakers, intelligent routing, micro-proxy, control bus, one-time tokens, global locks, leadership election, distributed sessions, cluster state). Coordination of distributed systems leads to boiler plate patterns, and using Spring Cloud developers can quickly stand up services and applications that implement those patterns.`

2016年9月，Linked 背后的创业公司 Buoyant 第一次在 SF Microservices 提出了一个新概念“Service Mesh”，并随后在 2017 年 4月 Buoyant 的 William Morgan 给 Service Mesh 做了定义：

`A service mesh is a dedicated infrastructure layer for handling service-to-service communication. It’s responsible for the reliable delivery of requests through the complex topology of services that comprise a modern, cloud native application. In practice, the service mesh is typically implemented as an array of lightweight network proxies that are deployed alongside application code, without the application needing to be aware.`

**are deployed alongside application code, without the application needing to be aware** 这句话就是 mesh 的核心，换句话说，使用一种应用无感知和无侵入的方式实现集群服务。这是一种全新的实现方式，这意味着实现微服务框架从与应用强绑定和依赖变成了弱绑定和无依赖，应用可以非常灵活的选择自己的框架，这变得非常的灵活和轻量，无需强绑定到框架的规范之中，可以选择任何一个语言，可以无需依赖框架的版本更新和升级，从外部的层面去解决集群服务间的调用、配置、全局锁、负载均衡、路由等问题，这种灵活性也给项目管理带来了巨大的福音，框架和应用的分离使微服务开发相比 SpringCloud 这种侵入性框架更加优雅！

而实现这种分离的核心是 mesh 引入了“代理”机制，具体实现就是 Linked 和 Envoy 组件劫持应用对外的所有的网络通信，代理控制这些通信的往来，所有的代理节点组成一个网络，并对外提供扩展接口，对接网络的控制器，控制器根据系统状态进行统一调度，这个网络就像一个格子一样，也就是 mesh 的含义。

2017年5月24日，Google 和 IBM 高调宣布基于 Service Mesh 的服务化框架 Istio 0.1 发布，出身命名的 Istio 一下子火了，给 Linked 承重一击，瞬间陷入黑暗，Istio 收编了 Envoy 作为数据转发层，上层控制层面提供 Pilot、Mixer、Istio-Auth 组件。

1. Envoy: 与应用部署在一起，提供服务间请求高效转发，并提供扩展接口以实现不同的转发策略，同时上报流量监控数据，提供 HTTP、gRPC、TCP 转发能力。
* Mixer：提供监控数据管理、路由、负载均衡、路由、调用追踪等流量管理，是控制器的核心，并提供后端对接平台，如k8s、Mesos等。
* Pilot（飞行员）: Mixer 的执行模块，负责对 Envoy 进行运行时配置。
* Istio-Auth：提供服务间 TLS 安全通信、角色鉴权、用户认证等 AAA 管理。

![img](/assets/media/istio_arch.svg)


#### eBPF 介绍

Kernel 3.18 中 eBPF(Extended Berkeley Packet Filter)提供了一种在网络栈的钩子节点处运行用户代码的能力，框架具备高扩展性、可编程和动态运行时的能力，eBPF 使用 llvm 把用户 C 语言代码编译成 eBPF 可执行文件在内核态执行，这为上层应用提供了网络安全、流量控制的能力。但编写 eBPF 代码有一定的限制性，目的是为了不破坏内核的稳定性，eBPF 提供了一种叫 verifier 的机制对代码进行巡检，确保用户代码在短时间执行完毕，比如用户代码最大只能执行 4096 个 BPF 指令，并对循环结构进行限制。

BPF 提供几个重要的编程组件有下：

1. Helper Func：提供一些从内核中读写数据流的函数集。
* Maps：内核中存储 KV 的 Map 集。
* Object Pinning
* Tail Calls：用户一个 BPF 应用调用另一个 BPF 应用。
* BPF to BPF Calls：最新内核新增了 BPF 应用间直接调用能力。
* JIT：即时翻译执行代码能力
* Hardening：
* Offloads：允许用户代码下沉到网卡中执行

##### BPF 程序的限制

1. 在 Kernel 4.16 和 LLVM 6.0 之前不支持普通函数调用，所有调用必须为内联函数
* 不支持共享库调用（使用 bfp/lib 定义的库）
* 不允许全局变量，但可以使用 `BPF_MAP_TYPE_PERCPU_ARRAY` 作为全局 map 存储状态信息，并可以在多个 BPF 程序间共享数据
* 不允许使用字符串常量和数组
* 限制性的使用循环，BPF verifier 验证程序会检测代码是否有循环，使用 `#pragma unroll` 和 `BPF_MAP_TYPE_PERCPU_ARRAY` 最大只能支持 32 次迭代
* 栈空间限制大小 512 bytes

#### Cilium

Cilium 是一个强大的以 eBPF 为基础的网络框架，能做到 L347 层的安全策略、流量控制的能力，并具备高性能，主要解决微服务的使用场景，官方解释如下：

`Cilium is open source software for transparently securing the network connectivity between application services deployed using Linux container management platforms like Docker and Kubernetes.
The development of modern datacenter applications has shifted to a service-oriented architecture often referred to as microservices, wherein a large application is split into small independent services that communicate with each other via APIs using lightweight protocols like HTTP. Microservices applications tend to be highly dynamic, with individual containers getting started or destroyed as the application scales out / in to adapt to load changes and during rolling updates that are deployed as part of continuous delivery.
This shift toward highly dynamic microservices presents both a challenge and an opportunity in terms of securing connectivity between microservices. Traditional Linux network security approaches (e.g., iptables) filter on IP address and TCP/UDP ports, but IP addresses frequently churn in dynamic microservices environments. The highly volatile life cycle of containers causes these approaches to struggle to scale side by side with the application as load balancing tables and access control lists carrying hundreds of thousands of rules that need to be updated with a continuously growing frequency.
By leveraging Linux BPF, Cilium retains the ability to transparently insert security visibility + enforcement, but does so in a way that is based on service / pod / container identity (in contrast to IP address identification in traditional systems) and can filter on application-layer (e.g. HTTP). As a result, Cilium not only makes it simple to apply security policies in a highly dynamic environment by decoupling security from addressing, but can also provide stronger security isolation by operating at the HTTP-layer in addition to providing traditional Layer 3 and Layer 4 segmentation.`

Cilium 架构如下：

![img](/assets/media/cilium.png)

Cilium 已实现的功能如下：

1. 支持 HTTP 协议，支持 method、path、host、headers 匹配的策略
* 支持 Kafka 的协议，支持 Role、topic 匹配的策略管理
* 支持 IP/CIDR、Label、Service、Entities Base 的策略管理
* 负载均衡
* 监控和故障定位，支持对接 Prometheus 监控平台

#### 一个简单的 BPF 代码事例
