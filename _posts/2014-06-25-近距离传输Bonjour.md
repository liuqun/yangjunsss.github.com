---
layout: post
title: Bonjour用于近距离传输（更新ing）
categories: [ios]
tags:
fullview: false
keywords: bonjour

---

一直想看看近距离传输，特别是“快牙”火了之后，本来想看看古老的蓝牙传输，但这种技术显然落后了，耗电，慢和不稳定。[bonjour](https://developer.apple.com/bonjour/index.html)是apple提供的一种基于TCP/IP，无配置的通信服务，可用于近距离传输，遵循Apache 2.0 license，支持wi-fi和蓝牙。名字也有点意思，“你好”，很神似。Apple从7.0后提供了一个对bonjour的high level的Framework，`MultipeerConnectivity.framework`.官方有个[sample code](https://developer.apple.com/library/ios/samplecode/MultipeerGroupChat/Introduction/Intro.html#//apple_ref/doc/uid/DTS40013691)（我在2台ios7的pad上已实验正常）就是使用MultipeerConnectivity.framework来做的，但是对于需要支持ios7以下的App来说就歇菜了，所以还是得用NSNetService或者CFNetService等来实现。

**bonjour需要做3件事：**

1,Publishing a Network Service

建立一个网络服务，并用服务的命名和类型来替换传统的IP地址和端口。而且命名更具有可读性。比如：Zealous Lizard's Tune Studio._music._tcp.local，整个过程如图：

![tu1](/assets/media/屏幕快照 2014-06-26 12.00.35 AM.png)


2,Browsing for and connecting to a Network Service

询问和建立连接，bonjour的询问方式更加明确，比如用“What print services are available?”替换掉“What services are you running?”，整个过程如图：

![tu2](/assets/media/屏幕快照 2014-06-26 12.02.14 AM.png)

3,Resolution

service name 和 地址端口的相互解析，用service name重新广播得到最新的IP地址和端口。

![tu3](/assets/media/屏幕快照 2014-06-26 12.05.06 AM.png)

**API layers：**

Top

^

|  NSNetService NSNetServiceBrowser

|  CFNetServices

|  DNS　Service Discovery API

Low


用NSNetService进行publish：

{% highlight objective-c %}
        NSNetService *service = [[NSNetService alloc] initWithDomain:@"" type:@"" name:@""];
        [service scheduleInRunLoop:[NSRunLoop currentRunLoop] forMode:NSRunLoopCommonModes];
        [service setDelegate:self];
        [service publish];
{% endhighligh %}

进行browsing：

{% highlight objective-c %}
        NSNetServiceBrowser *browser = [NSNetServiceBrowser new];
        [browser setDelegate:self];
        [browser searchForServicesOfType:@"_moodring._tcp" inDomain:@""];
{% endhighligh %}










