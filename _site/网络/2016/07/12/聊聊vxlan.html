<!DOCTYPE html>
<html lang="tr">
<head>
	<meta charset="utf-8">
	<title>yj的博客 聊聊vxlan</title>
	<meta name="keywords" content="vxlan,sdn">
	<meta name="description" content="">
	<meta name="author" content="yj" >
	<!-- Enable responsive viewport -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

	<!-- Le styles -->
	<link href="/assets/resources/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="/assets/resources/font-awesome/css/font-awesome.min.css" rel="stylesheet">
	<link href="/assets/resources/syntax/syntax.css" rel="stylesheet">
	<link href="/assets/css/style.css" rel="stylesheet">

	<!-- Le fav and touch icons -->
	<!-- Update these with your own images
	<link rel="shortcut icon" href="images/favicon.ico">
	<link rel="apple-touch-icon" href="images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
	-->

	<link rel="alternate" type="application/rss+xml" title="" href="/feed.xml">
</head>

<body>

	<script type="text/javascript" src="http://tajs.qq.com/stats?sId=34536989" charset="UTF-8"></script>
				
	<nav class="navbar navbar-default visible-xs" role="navigation">
		<!-- Brand and toggle get grouped for better mobile display -->
		<div class="navbar-header">
			<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
			<a type="button" class="navbar-toggle nav-link" href="http://github.com/yangjunsss">
				<i class="fa fa-github"></i>
			</a>
			
			
			
			<a type="button" class="navbar-toggle nav-link" href="mailto:cj.yangjun@gmail.com">
				<i class="fa fa-envelope"></i>
			</a>
			
			<a class="navbar-brand" href="/">
				<img src="/assets/ico/avatar.png" class="img-circle" height="27" width="27"/>
				yj的博客
			</a>
		</div>

		<!-- Collect the nav links, forms, and other content for toggling -->
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				<li class="active"><a href="/">Home</a></li>
				<li><a href="/categories.html">Categories</a></li>
				<li><a href="/tags.html">Tags</a></li>
			</ul>
		</div><!-- /.navbar-collapse -->
	</nav>

	<!-- nav-menu-dropdown -->
	<div class="btn-group hidden-xs" id="nav-menu">
		<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
			<i class="fa fa-bars"></i>
		</button>
		<ul class="dropdown-menu" role="menu">
			<li><a href="/"><i class="fa fa-home"></i> Home</a></li>
			<li><a href="/categories.html"><i class="fa fa-folder"></i> Categories</a></li>
			<li><a href="/tags.html"><i class="fa fa-tags"></i> Tags</a></li>
			<li class="divider"></li>
			<li><a href="#"><i class="fa fa-arrow-up"></i> Top of Page</a></li>
		</ul>
	</div>

	<div class="col-sm-3 sidebar hidden-xs">
		<! -- sidebar.html -->
<header class="sidebar-header" role="banner">
	<a href="/">
		<img src="/assets/ico/avatar.jpg" class="img-circle" width="200" height="200"/>
	</a>
	<h3 class="title">
        <a href="/">yj的博客</a>
    </h3>
</header>


<div id="bio" class="text-center">
	I'm a Dev and Trader
</div>


<div id="contact-list" class="text-center">
	<ul class="list-unstyled list-inline">
		
		<li>
			<a class="btn btn-default btn-sm" href="https://github.com/yangjunsss">
				<i class="fa fa-github-alt fa-lg"></i>
			</a>
		</li>
		
		
		
		<li>
			<a class="btn btn-default btn-sm" href="mailto:cj.yangjun@gmail.com">
				<i class="fa fa-envelope fa-lg"></i>
			</a>
		</li>
		
	</ul>
	<ul id="contact-list-secondary" class="list-unstyled list-inline">
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://linkedin.com/in/yj-chen-0525b8104">
				<i class="fa fa-linkedin fa-lg"></i>
			</a>
		</li>
		
		<li>
			<a class="btn btn-default btn-sm" href="/feed.xml">
				<i class="fa fa-rss fa-lg"></i>
			</a>
		</li>
	</ul>
</div>
<! -- sidebar.html end -->

	</div>

	<div class="col-sm-9 col-sm-offset-3">
		<div class="page-header">
  <h1>聊聊vxlan </h1>
</div>
	
<article>

	<div class="col-sm-10">
	 <span class="post-date">
	   
	   July 
	   12th,
	   
	   2016
	 </span>
	  <div class="article_body">
	  <h3 id="section">问题</h3>

<p>在云计算的服务里，我们需要在物理的二层网络或者三层网络里虚拟化出二层网络供租户使用，而划分出这个虚拟网络其中一种方案是VLAN，VLAN通过一个12-bit的VLAN ID来对应一个虚拟网络，配置在数据链路层，它相当于把一个大的二层网络切分成许多小的逻辑网络，每个VLAN ID配置和管理着N个VM的MAC地址，在数据链路层实现不同的广播域，从而到达隔离和划分的目的。正因为这只有12-bit，就只能虚拟出4094个VLAN，显然是不够的，这是<strong>问题1</strong>。</p>

<p><strong>问题2</strong>，用户需要在不同的二层网路里相互通讯，而不同的VLAN之间通讯要通过第三层完成。<strong>问题3</strong>，我们知道二层网络之间的通讯都是通过MAC地址寻址，而在虚拟化的世界里，vm会被虚拟化非常多，这么多vm在同一个物理网络下，带来了ARP flood的问题。</p>

<h3 id="vxlan">VXLAN</h3>

<p>VXLAN全称是<strong><em>Virtual eXtensible Local Area Network</em></strong>，设计的目的就是要满足构建在二层或者三层物理网络下的虚拟网络，主要给Cloud使用，设计思路由VLAN所启发，不过他比VLAN协议要高一层，在第三层协议UDP之上，对UDP进行封装，增加了8byte的VXLAN Header，其中24bit用作VNI，VNI跟VLAN ID作用一样，用于分组，这里的24bit解决了<strong>问题1</strong>。</p>

<p>而基于UDP协议的封装数据包可自由穿梭于二层和三层，解决了<strong>问题2</strong>。</p>

<p>vxlan用于对数据包进行封包和拆包的模块被称作VTEP，它是个管理模块，可以部署在物理机或物理交换机上，用硬件或软件都可以实现，同VLAN一样，要管理虚拟网络和物理网络的一些映射关系表，比如VNI和MAC地址的映射表、VNI和多播组的映射表，VNI和VTEP地址的映射表等。可以看出来，跟VLAN有点像，从VXLAN名字也能看出来，只不过是云计算版。下面看看如何通信的。</p>

<h4 id="vm1-to-vm2mac">1,vm1 to vm2，MAC地址通信</h4>

<p>当一个vm1加入到一个VXLAN的network后，并不需要知道是否在VXLAN里，对于客户机来讲是透明的，vm1只要发送包含目的地址为vm2的MAC地址IP数据包，vm1所在的物理机VTEP1收到这个包，就会根据目的MAC地址查询VNI&lt;-&gt;MAC表，如果找到对应的VNI，进行UDP打包，包上目标VTEP2的MAC地址、IP地址、目的VNI、目的vm2的MAC地址、源vm1的MAC地址等发给VTEP2，VTEP2收到后进行确认和拆包，发送到vm2，并在这个过程中学习到vm1的MAC地址、VTEP1的地址，当vm2进行回包的时候，同样的过程返回给vm1，这样整个vm到vm的通信就完成了。</p>

<h4 id="vm1-to-vm2-mac">2,vm1 to vm2 不知道MAC地址</h4>

<p>当vm1不知道vm2的MAC地址进行IP地址通信的时候，同传统网络一样，会先判断是否为子网地址，然后进行ARP广播来获取目的MAC地址，这个ARP广播包会广播给所有二层的机器，在虚拟化vm的世界里，每个vm过段时间都进行ARP广播来保持对方的感知，ARP广播就会非常多，造成广播风暴，广播的问题是说网卡在处理网络数据包的时候会进行过滤，通常网卡会处理所有广播的数据帧，然后一层一层往上传递，并进行过滤，一直到应用层，而大多数时候，上层对广播的数据帧并不感兴趣，这种传递和过滤就造成了负荷，而另一种数据传输方式多播就会好很多，网卡遇到多播地址的数据帧时就可以进行过滤。</p>

<p>VXLAN则用了多播的形式来“广播”ARP请求，并维护着一个VNI到多播组地址的映射，来减少广播带来的问题，并在这个过程中进行学习，建立转发规则，这种学习非常重要，它主要解决ARP Flood的问题，在vm下次进行ARP广播的时候有能力消化ARP请求，解决ARP Flood，解决<strong>问题3</strong>。</p>

<p>一个VXLAN典型的部署如下：</p>

<p><img src="http://yangjunsss.github.io/assets/media/QQ20160712-1@2x.png" alt="img" /></p>

<p>可以看到，VXLAN的分组的思想同VLAN很相似，但VLAN在SDN里并不适合，因为不够灵活，VXLAN之所以强大，因为Cloud里的hyper管理着所有vm，拥有着控制力，这种控制力能对网络进行灵活的控制，这才是云计算未来的网络架构。</p>

<p><strong><em>Copyright © 2016 yangjunsss. All rights reserved.</em></strong></p>


	  </div>
<!--
		
		<ul class="tag_box list-unstyled list-inline">
		  <li><i class="fa fa-folder-open"></i></li>
		  
		  
			 
				<li><a href="/categories.html#网络-ref">
					网络 <span>(1)</span>
					
				</a></li>
			
		  
		</ul>
		  

		
		<ul class="list-inline">
		  <li><i class="fa fa-tags"></i></li>
		  
		  
			 
				<li>
					<a href="/tags.html#vxlan-ref">
					vxlan <span>(1)</span>
					
					</a>
				</li>
			
		  
		  
		</ul>
		  

		<hr>
-->
		<div>
      <section class="share">
        <h4 class="section-title">Share Post</h4>
        <a class="btn btn-default btn-sm twitter" href="http://twitter.com/share?text=聊聊vxlan"
           onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
          <i class="fa fa-twitter fa-lg"></i>
          Twitter
        </a>
        <a class="btn btn-default btn-sm facebook" href="https://www.facebook.com/sharer/sharer.php"
           onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
          <i class="fa fa-facebook fa-lg"></i>
          Facebook
        </a>
        <a class="btn btn-default btn-sm gplus"
           onclick="window.open('https://plus.google.com/share?url='+window.location.href, 'google-plus-share', 'width=490,height=530');return false;">
          <i class="fa fa-google-plus fa-lg"></i>
          Google+
        </a>

      </section>
  <!--     <section style="text-algin:right">
<script type="text/javascript">
document.write("<img src=\"https://chart.googleapis.com/chart?cht=qr&chs=120x120&choe=UTF-8&chld=L|2&chl="+encodeURI(window.location.href)+"\" width=\"120\" height=\"120\"/></img>");
</script>
</section>-->
     <!-- <section class="col-sm-6 author">
        <img src="http://www.gravatar.com/avatar/" class="img-rounded author-image" />
        <h4 class="section-title author-name">yj</h4>
        <p class="author-bio">I'm a Dev and Trader</p>
      </section>
!-->
    </div>

    <div class="clearfix"></div>

		<ul class="pager" style="font-size:12px;">
		  
		  <li class="previous"><a href="/%E5%B7%A5%E5%85%B7/2016/07/10/XXAlignOnSave.html" title="写了一个Xcode插件XXAlignOnSave">&larr; Previous</a></li>
		  
		  
			<li class="next disabled"><a>Next &rarr;</a>
		  
		</ul>

		<hr>
	</div>
	
	<div class="col-sm-2 sidebar-2">
	
	</div>
</article>
<div class="clearfix"></div>

   <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'yangjunsss'; // required: replace example with your forum shortname
        //var disqus_identifier = encodeURI(window.location.href);
        //var disqus_url = encodeURI(window.location.href);
        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    
        <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'yangjunsss'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
    </script>
    
    
    


		<footer>
			<hr/>
			<p>
				&copy; 2016 yj with Jekyll. Theme: <a href="https://github.com/dbtek/dbyll">dbyll</a> by dbtek. <br/>本博仅代表个人观点，与公司无关，某些地方纯属意淫。
			</p>
		</footer>
	</div>

	<script type="text/javascript" src="/assets/resources/jquery/jquery.min.js"></script>
	<script type="text/javascript" src="/assets/resources/bootstrap/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="/assets/js/app.js"></script>
</body>
</html>

